---
- name: Create VPCs in different region
  module_defaults:
    group/aws:
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      aws_security_token: "{{ security_token | default(omit) }}"
      region: "{{ aws_region }}"
  block:
    - name: Create VPCs from first region
      amazon.aws.ec2_vpc_net:
        cidr_block: "{{ item.cidr_block }}"
        name: "{{ item.name }}"
        region: "{{ test_vpc_region }}"
      with_items: "{{ test_vpc_region_1.vpcs }}"
      register: __vpcs_region1
      vars:
        test_vpc_region: "{{ test_vpc_region_1.region }}"

    - name: Create VPCs from second region
      amazon.aws.ec2_vpc_net:
        cidr_block: "{{ item.cidr_block }}"
        name: "{{ item.name }}"
        region: "{{ test_vpc_region }}"
      with_items: "{{ test_vpc_region_2.vpcs }}"
      when: test_vpc_region_2 is defined
      register: __vpcs_region2
      vars:
        test_vpc_region: "{{ test_vpc_region_2.region }}"
