---
- name: Delete VPCs
  module_defaults:
    group/aws:
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      aws_security_token: "{{ security_token | default(omit) }}"
      region: "{{ aws_region }}"
  block:
    - name: Delete VPC from region 1
      amazon.aws.ec2_vpc_net:
        cidr_block: "{{ item.cidr_block }}"
        name: "{{ item.name }}"
        region: "{{ test_vpc_region }}"
        state: absent
      with_items: "{{ test_vpc_region_1.vpcs }}"
      vars:
        test_vpc_region: "{{ test_vpc_region_1.region }}"

    - name: Delete VPC from region 2
      amazon.aws.ec2_vpc_net:
        cidr_block: "{{ item.cidr_block }}"
        name: "{{ item.name }}"
        region: "{{ test_vpc_region }}"
        state: absent
      with_items: "{{ test_vpc_region_2.vpcs }}"
      when: test_vpc_region_2 is defined
      vars:
        test_vpc_region: "{{ test_vpc_region_2.region }}"
